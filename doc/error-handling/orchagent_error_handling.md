# HLD Name #

## Table of Content

### Revision

### Scope

This document describe the details of error handling in SONiC Orchestration Agent to gracefully handle ASIC/SAI programming failures back to applications

### Definitions/Abbreviations

This section covers the abbreviation if any, used in this high-level design document and its definitions.

### Overview

Orchestration Agent (a.k.a orchagent) is one of the most critical components in SONiC that is responsible for translating the data generated by applications into SAI objects that can be pushed down to the hardware via the southbound interface. As such, the reliability of this component is of great importance to the stability and availability of system running SONiC. Currently, most of the ASIC/SAI programming failures in SONiC result in a crash/restart of orchagent which can potentially cause dataplane impact and degraded customer experience. This is a day-1 behavior which is acceptable in certain cases but undesirable in most customer deployments. The intent of this document is to come up with a design where such errors are handled gracefully by orchagent without a crash or restart while notifying applications of those errors using appropriate return values. The application may then choose to act on the error as appropriate.

### Requirements

The requirements for orchagent error handling improvement are as follows:

    - Handle all ASIC/SAI programming errors gracefully without causing orchagent to crash or restart
    - Return appropriate value (zero or non-zero) to applications so that they can determine the right error recovery mechanism (For eg: rollback or retry)
    - Add appropriate logs when an error is handled to aid debugging or automated log analysis tools

### Architecture Design

No change in SONiC architecture is intended with this orchagent error handling behavioral change.

### High-Level Design

The orchagent error handling behavioral change introduced here will be the standard behavior going forward on all SONiC platforms with no option to retain the existing behavior. All changes will be limited to orchagent inside the swss container.

The following SAI errors are planned to be gracefully handled by orchagent:

    - SAI_STATUS_NOT_SUPPORTED
    - SAI_STATUS_NO_MEMORY
    - SAI_STATUS_INSUFFICIENT_RESOURCES
    - SAI_STATUS_INVALID_PARAMETER
    - SAI_STATUS_ITEM_ALREADY_EXISTS
    - SAI_STATUS_ITEM_NOT_FOUND
    - SAI_STATUS_BUFFER_OVERFLOW
    - SAI_STATUS_INVALID_PORT_NUMBER
    - SAI_STATUS_INVALID_PORT_MEMBER
    - SAI_STATUS_INVALID_VLAN_ID
    - SAI_STATUS_UNINITIALIZED
    - SAI_STATUS_TABLE_FULL
    - SAI_STATUS_MANDATORY_ATTRIBUTE_MISSING
    - SAI_STATUS_NOT_IMPLEMENTED
    - SAI_STATUS_ADDR_NOT_FOUND
    - SAI_STATUS_OBJECT_IN_USE
    - SAI_STATUS_INVALID_OBJECT_TYPE
    - SAI_STATUS_INVALID_OBJECT_ID
    - SAI_STATUS_INVALID_NV_STORAGE
    - SAI_STATUS_NV_STORAGE_FULL
    - SAI_STATUS_SW_UPGRADE_VERSION_MISMATCH
    - SAI_STATUS_NOT_EXECUTED
    - SAI_STATUS_INVALID_ATTRIBUTE_X
    - SAI_STATUS_INVALID_ATTR_VALUE_X
    - SAI_STATUS_ATTR_NOT_IMPLEMENTED_X
    - SAI_STATUS_UNKNOWN_ATTRIBUTE_X
    - SAI_STATUS_ATTR_NOT_SUPPORTED_X

## Orchagent changes

All places in orchagent which process return values from SAI operations will need to call into one of handleSaiCreateStatus(), handleSaiSetStatus(), handleSaiGetStatus() or handleSaiRemoveStatus() as appropriate which will gracefully handle the error and determine if the operation needs to be retried by the application or not.


### SAI API

No new SAI APIs are introduced as part of this functionaility.

### Configuration and management
There are no configuration and management changes introduced as part of this functionality.

#### CLI/YANG model Enhancements

There is no CLI change associated with this functionality.

#### Config DB Enhancements

There is no config DB change needed for this functionality.

### Warmboot and Fastboot Design Impact

This error handling improvement does not have any requirements or dependencies w.r.t warmboot or fastboot.

### Memory Consumption

No additional memory overhead is anticipated in implementing this functionality.

### Restrictions/Limitations

### Testing Requirements/Design

#### Unit Test cases

The unit test plan for orchagent error handling is documented below:

| Error Handling | S.No | Test description                                             |
| -------------- | ---- | ------------------------------------------------------------ |
|                | 1.1  | Verify that orchagent does not crash when SAI_STATUS_NOT_SUPPORTED is returned |
|                | 1.2  | Verify that orchagent does not crash when SAI_STATUS_NO_MEMORY is returned |
|                | 1.3  | Verify that orchagent does not crash when SAI_STATUS_INSUFFICIENT_RESOURCES is returned |
|                | 1.4  | Verify that orchagent does not crash when SAI_STATUS_INVALID_PARAMETER is returned |
|                | 1.5  | Verify that orchagent does not crash when SAI_STATUS_ITEM_ALREADY_EXISTS is returned |
|                | 1.6  | Verify that orchagent does not crash when SAI_STATUS_ITEM_NOT_FOUND is returned |
|                | 1.7  | Verify that orchagent does not crash when SAI_STATUS_TABLE_FULL is returned |
|                | 1.8  | Verify that orchagent does not crash when SAI_STATUS_NOT_IMPLEMENTED is returned |
|                | 1.9  | Verify that orchagent does not crash when SAI_STATUS_OBJECT_IN_USE is returned |
|                | 1.10 | Verify that orchagent does not crash when SAI_STATUS_NOT_EXECUTED is returned |

#### System Test cases

### Open/Action items - if any
